@using Superset.Common
@using Superset.Web.State
@using Microsoft.JSInterop

@typeparam T

@inject IJSRuntime JSRuntime

<div class="FlareSelect_Container @(!FlareSelector.Multiple ? "FlareSelect_Container--Single" : "FlareSelect_Container--Multiple")">
    <div class="FlareSelect_SelectedContainer">

        <div class="FlareSelect_Selected" @ref="@_selectedRef" tabindex="0">
            <TriggerWrapper Trigger="@FlareSelector.OnSelectionChange">
                @foreach ((int, IOption<T>) option in FlareSelector.Selected())
                {
                    <div class="FlareSelect_Selection">
                        @option.Item2.SelectedText
                        <button class="FlareSelect_SelectionRemoveButton" @onclick="@(_ => FlareSelector.Select(option.Item1, option.Item2))">âœ•</button>
                    </div>
                }
            </TriggerWrapper>

        </div>

        @if (FlareSelector.Multiple)
        {
            <div class="FlareSelect_FilterInputContainer">
                <TriggerWrapper Trigger="@FlareSelector.OnSelectionChange">
                    <input type="text" class="FlareSelect_FilterInput" value="@FlareSelector.FilterValue" @oninput="UpdateFilterValue" tabindex="0" placeholder="Filter options" @ref="@_inputRef"/>
                </TriggerWrapper>
                <svg class="FlareSelect_FilterInputSearchIcon" viewBox="0 0 20 20">
                    <path d="M18.125,15.804l-4.038-4.037c0.675-1.079,1.012-2.308,1.01-3.534C15.089,4.62,12.199,1.75,8.584,1.75C4.815,1.75,1.982,4.726,2,8.286c0.021,3.577,2.908,6.549,6.578,6.549c1.241,0,2.417-0.347,3.44-0.985l4.032,4.026c0.167,0.166,0.43,0.166,0.596,0l1.479-1.478C18.292,16.234,18.292,15.968,18.125,15.804 M8.578,13.99c-3.198,0-5.716-2.593-5.733-5.71c-0.017-3.084,2.438-5.686,5.74-5.686c3.197,0,5.625,2.493,5.64,5.624C14.242,11.548,11.621,13.99,8.578,13.99 M16.349,16.981l-3.637-3.635c0.131-0.11,0.721-0.695,0.876-0.884l3.642,3.639L16.349,16.981z"></path>
                </svg>
            </div>
        }

    </div>

    <div class="FlareSelect_OptionsContainer" tabindex="1" @onkeypress="@OnOptionsKeypress" @ref="@_optionsRef">
        <TriggerWrapper Trigger="@_onToggle" Protected="true">
            <div class="FlareSelect_Options" hidden="@(!_shown)">
                @if (!FlareSelector.Multiple)
                {
                    <div class="FlareSelect_FilterInputContainer">
                        <TriggerWrapper Trigger="@FlareSelector.OnSelectionChange">
                            <input type="text" class="FlareSelect_FilterInput" value="@FlareSelector.FilterValue" @oninput="UpdateFilterValue" tabindex="0" placeholder="Filter options" @ref="@_inputRef"/>
                        </TriggerWrapper>
                        <svg class="FlareSelect_FilterInputSearchIcon" viewBox="0 0 20 20">
                            <path d="M18.125,15.804l-4.038-4.037c0.675-1.079,1.012-2.308,1.01-3.534C15.089,4.62,12.199,1.75,8.584,1.75C4.815,1.75,1.982,4.726,2,8.286c0.021,3.577,2.908,6.549,6.578,6.549c1.241,0,2.417-0.347,3.44-0.985l4.032,4.026c0.167,0.166,0.43,0.166,0.596,0l1.479-1.478C18.292,16.234,18.292,15.968,18.125,15.804 M8.578,13.99c-3.198,0-5.716-2.593-5.733-5.71c-0.017-3.084,2.438-5.686,5.74-5.686c3.197,0,5.625,2.493,5.64,5.624C14.242,11.548,11.621,13.99,8.578,13.99 M16.349,16.981l-3.637-3.635c0.131-0.11,0.721-0.695,0.876-0.884l3.642,3.639L16.349,16.981z"></path>
                        </svg>
                    </div>
                }

                @* <TriggerWrapper Trigger="@FlareSelector.OnDataChange" Protected="true"> *@
                @for (var b = 0; b < FlareSelector.Batches.Length; b++)
                {
                    int batchID = b;

                    <TriggerWrapper Trigger="@FlareSelector.Batches[batchID].Item1" Protected="true">
                        @for (var o = 0; o < FlareSelector.Batches[batchID].Item2.Count; o++)
                        {
                            IOption<T> d = FlareSelector.Batches[batchID].Item2[o];

                            if (d.Placeholder)
                            {
                                <div class="FlareSelect_Option--Placeholder" hidden="@(!FlareSelector.IsOptionShown(d))" tabindex="0">@d.OptionText</div>
                            }
                            else if (d.Disabled)
                            {
                                <div class="FlareSelect_Option--Disabled" hidden="@(!FlareSelector.IsOptionShown(d))" tabindex="0">@d.OptionText</div>
                            }
                            else if (FlareSelector.IsOptionSelected(d))
                            {
                                <div class="FlareSelect_Option--Selected" hidden="@(!FlareSelector.IsOptionShown(d))" id="FS_O_@(batchID)_@(o)" tabindex="0">@d.OptionText</div>
                            }
                            else
                            {
                                <div hidden="@(!FlareSelector.IsOptionShown(d))" id="FS_O_@(batchID)_@(o)" tabindex="0">@d.OptionText</div>
                            }
                        }
                    </TriggerWrapper>
                }
                @* </TriggerWrapper> *@
            </div>
        </TriggerWrapper>
    </div>
</div>